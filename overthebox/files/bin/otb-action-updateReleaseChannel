#!/bin/sh
# shellcheck disable=SC1091
# vim: set noexpandtab tabstop=4 shiftwidth=4 softtabstop=4 :

set -e
set -o pipefail

. /lib/overthebox
. /etc/os-release

data=$(otb_device_get release_channel)

# Update the relase channel name
uci -q set overthebox.me.release_channel="$(jq -r -n --argjson data "$data" '$data.name')"
uci -q commit

# Update the distfeeds configuration
jq -r -n --argjson data "$data" '$data.feeds[] | [.type,.name,.url] | join(" ")' | \
	sed "s^@ARCH@^$LEDE_ARCH^; s^@BOARD@^$LEDE_BOARD^" > /etc/opkg/distfeeds.conf
