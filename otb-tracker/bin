#!/bin/sh
# vim: set noexpandtab tabstop=4 shiftwidth=4 softtabstop=4 :

# shellcheck disable=SC1091
. /lib/overthebox

while true; do
	glorytun path dev tun0 2>/dev/null | (
		ACTION=down

		MAX_RTT=0
		TOTAL_RATE_TX=0
		OVERHEAD=22

		while read -r _ _ STATUS IP _ PUBIP _ _ _ _ RTT _ RATE_TX _ _ _; do
			[ "$STATUS" = "OK" ] && ACTION=up

			[ "$PUBIP" ] || continue
			[ "$PUBIP" = "-" ] && continue

			if [ "$RTT" != "-" ]; then
				RTT="${RTT%%.*}"
				[ "$RTT" -gt "$MAX_RTT" ] && MAX_RTT=${RTT%%*.}
			fi

			[ "$RATE_TX" != "-" ] && TOTAL_RATE_TX=$(( TOTAL_RATE_TX + RATE_TX ))

			PUBIP_OLD=$(otb_get_data "$IP/pubip")
			[ "$PUBIP" = "$PUBIP_OLD" ] && continue

			otb_set_data "$IP/pubip" "$PUBIP"

			asn="$(curl --max-time 2 --silent --show-error "api.iptoasn.com/v1/as/ip/$PUBIP")"
			[ "$asn" ] && otb_set_data "$IP/asn" "$asn"
		done

		tc qdisc replace dev tun0 root cake \
			bandwidth "$(( TOTAL_RATE_TX * 9 / 10 ))bps" \
			rtt "${MAX_RTT}ms" \
			diffserv4 \
			flows \
			wash \
			nat \
			overhead "$OVERHEAD" noatm

		ubus -S call network.interface.tun0 "$ACTION"
	)
	sleep 5
done
